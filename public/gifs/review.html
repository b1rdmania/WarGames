<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>WarGames GIF Review</title>
    <style>
      :root {
        --bg: #07120c;
        --bg2: #0d1c14;
        --panel: #102418;
        --line: #244230;
        --text: #d6f3de;
        --muted: #7ca18a;
        --accent: #63ff8a;
        --warn: #ffd166;
        --bad: #ff6b6b;
      }

      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Courier New", Courier, monospace;
        background: radial-gradient(circle at 20% 0%, var(--bg2), var(--bg));
        color: var(--text);
      }

      .wrap {
        max-width: 1400px;
        margin: 0 auto;
        padding: 16px;
      }

      .bar {
        position: sticky;
        top: 0;
        z-index: 10;
        background: rgba(7, 18, 12, 0.95);
        border: 1px solid var(--line);
        padding: 12px;
        margin-bottom: 12px;
        backdrop-filter: blur(4px);
      }

      h1 {
        margin: 0 0 10px;
        font-size: 18px;
        color: var(--accent);
      }

      .controls {
        display: grid;
        grid-template-columns: repeat(6, minmax(120px, 1fr));
        gap: 8px;
      }
      .presets {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      .presets button {
        width: auto;
        padding: 6px 10px;
        font-size: 11px;
      }

      input, select, button {
        width: 100%;
        border: 1px solid var(--line);
        background: var(--panel);
        color: var(--text);
        padding: 8px;
        font: inherit;
      }

      button { cursor: pointer; }
      button:hover { border-color: var(--accent); }

      .meta {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 10px;
        font-size: 12px;
        color: var(--muted);
      }

      .grid {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
      }

      .card {
        border: 1px solid var(--line);
        background: var(--panel);
        padding: 10px;
      }

      .thumb {
        width: 100%;
        min-height: 90px;
        display: grid;
        place-items: center;
        background: #000;
        border: 1px solid #1c3726;
        margin-bottom: 8px;
      }

      img {
        max-width: 100%;
        max-height: 180px;
        image-rendering: pixelated;
      }

      .name {
        font-size: 12px;
        word-break: break-all;
        margin-bottom: 6px;
      }

      .row {
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 4px;
      }
      .decision {
        font-size: 11px;
        margin-bottom: 6px;
      }
      .decision .approve { color: var(--accent); }
      .decision .reject { color: var(--bad); }

      .actions {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 6px;
        margin-top: 8px;
      }
      .actions button {
        padding: 6px 4px;
        font-size: 11px;
      }
      .actions .a-approve { border-color: #2f6641; color: var(--accent); }
      .actions .a-reject { border-color: #733636; color: var(--bad); }
      .actions .a-clear { border-color: var(--line); color: var(--muted); }

      .pill {
        display: inline-block;
        border: 1px solid var(--line);
        padding: 1px 6px;
        margin-right: 5px;
        margin-top: 3px;
        font-size: 10px;
      }

      .s-auto_accept { color: var(--accent); border-color: #2f6641; }
      .s-needs_review { color: var(--warn); border-color: #6b5720; }
      .s-reject { color: var(--bad); border-color: #733636; }

      .empty {
        border: 1px dashed var(--line);
        padding: 30px;
        text-align: center;
        color: var(--muted);
      }

      @media (max-width: 900px) {
        .controls { grid-template-columns: repeat(2, minmax(120px, 1fr)); }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="bar">
        <h1>WarGames GIF Review Console</h1>
        <div class="controls">
          <select id="status">
            <option value="all" selected>status: all</option>
            <option value="auto_accept">auto_accept</option>
            <option value="needs_review">needs_review</option>
            <option value="reject">reject</option>
          </select>
          <select id="theme">
            <option value="all">theme: all</option>
          </select>
          <select id="folder">
            <option value="all">folder: all</option>
            <option value="inbox">inbox</option>
            <option value="approved">approved</option>
            <option value="rejected">rejected</option>
          </select>
          <input id="q" placeholder="search filename/reason/theme" />
          <select id="sort">
            <option value="status">sort: status</option>
            <option value="size">sort: size</option>
            <option value="frames">sort: frames</option>
            <option value="name">sort: name</option>
          </select>
          <button id="reload">reload manifest</button>
        </div>
        <div class="presets">
          <button id="preset-full">full library</button>
          <button id="preset-review">review queue</button>
        </div>
        <div class="meta" id="meta"></div>
      </div>
      <div class="grid" id="grid"></div>
      <div class="empty" id="empty" style="display:none">No GIFs match this filter.</div>
    </div>

    <script>
      const state = {
        manifest: null,
        entries: [],
        decisions: {},
      };

      const els = {
        status: document.getElementById('status'),
        theme: document.getElementById('theme'),
        folder: document.getElementById('folder'),
        q: document.getElementById('q'),
        sort: document.getElementById('sort'),
        reload: document.getElementById('reload'),
        presetFull: document.getElementById('preset-full'),
        presetReview: document.getElementById('preset-review'),
        meta: document.getElementById('meta'),
        grid: document.getElementById('grid'),
        empty: document.getElementById('empty'),
      };

      function escapeHtml(value) {
        return String(value)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }

      async function loadManifest() {
        const res = await fetch('/gifs/catalog.manifest.json?ts=' + Date.now());
        if (!res.ok) throw new Error('manifest load failed: ' + res.status);
        const json = await res.json();
        state.manifest = json;
        state.entries = Array.isArray(json.entries) ? json.entries : [];
        await loadDecisions();
        populateThemeSelect();
        render();
      }

      async function loadDecisions() {
        const res = await fetch('/api/gifs/review?ts=' + Date.now());
        if (!res.ok) throw new Error('decision load failed: ' + res.status);
        const json = await res.json();
        state.decisions = json?.decisions || {};
      }

      function effectiveStatus(entry) {
        const d = state.decisions[entry.id];
        if (d === 'approve') return 'auto_accept';
        if (d === 'reject') return 'reject';
        return entry.status;
      }

      async function saveDecision(id, action) {
        const res = await fetch('/api/gifs/review', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, action }),
        });
        if (!res.ok) throw new Error('decision save failed: ' + res.status);
        const json = await res.json();
        state.decisions = json?.decisions || state.decisions;
      }

      function populateThemeSelect() {
        const themes = new Set();
        for (const e of state.entries) {
          for (const t of (e.themes || [])) themes.add(t);
        }
        const options = ['<option value="all">theme: all</option>']
          .concat([...themes].sort().map(t => `<option value="${escapeHtml(t)}">theme: ${escapeHtml(t)}</option>`));
        els.theme.innerHTML = options.join('');
      }

      function currentFilters() {
        return {
          status: els.status.value,
          theme: els.theme.value,
          folder: els.folder.value,
          q: els.q.value.trim().toLowerCase(),
          sort: els.sort.value,
        };
      }

      function matches(entry, f) {
        const status = effectiveStatus(entry);
        if (f.status !== 'all' && status !== f.status) return false;
        if (f.theme !== 'all' && !(entry.themes || []).includes(f.theme)) return false;
        if (f.folder !== 'all' && !String(entry.path || '').startsWith(f.folder + '/')) return false;
        if (!f.q) return true;

        const hay = [
          entry.id,
          entry.path,
          status,
          (entry.themes || []).join(' '),
          (entry.reasons || []).join(' '),
        ].join(' ').toLowerCase();

        return hay.includes(f.q);
      }

      function sortEntries(entries, key) {
        const data = [...entries];
        if (key === 'size') data.sort((a, b) => (b.sizeKb || 0) - (a.sizeKb || 0));
        else if (key === 'frames') data.sort((a, b) => (b.frames || 0) - (a.frames || 0));
        else if (key === 'name') data.sort((a, b) => String(a.id).localeCompare(String(b.id)));
        else {
          const rank = { needs_review: 0, reject: 1, auto_accept: 2 };
          data.sort((a, b) => (rank[a.status] ?? 9) - (rank[b.status] ?? 9));
        }
        return data;
      }

      function render() {
        const f = currentFilters();
        const filtered = sortEntries(state.entries.filter(e => matches(e, f)), f.sort);

        const c = {
          total: state.entries.length,
          auto_accept: state.entries.filter(e => effectiveStatus(e) === 'auto_accept').length,
          needs_review: state.entries.filter(e => effectiveStatus(e) === 'needs_review').length,
          reject: state.entries.filter(e => effectiveStatus(e) === 'reject').length,
        };

        els.meta.innerHTML = [
          `generated: ${escapeHtml(state.manifest?.generatedAt || 'n/a')}`,
          `total: ${c.total}`,
          `auto: ${c.auto_accept}`,
          `review: ${c.needs_review}`,
          `reject: ${c.reject}`,
          `showing: ${filtered.length}`,
        ].map(t => `<span>${t}</span>`).join('');

        if (!filtered.length) {
          els.grid.innerHTML = '';
          els.empty.style.display = 'block';
          return;
        }

        els.empty.style.display = 'none';
        els.grid.innerHTML = filtered.map(e => {
          const reasons = (e.reasons || []).length ? (e.reasons || []).join(', ') : 'none';
          const rawId = String(e.id || 'gif');
          const safeId = escapeHtml(rawId);
          const encodedId = encodeURIComponent(rawId);
          const decision = state.decisions[e.id] || '';
          const status = effectiveStatus(e);
          return `
            <article class="card">
              <div class="thumb"><img src="${escapeHtml(e.webPath)}" alt="${safeId}" loading="lazy" /></div>
              <div class="name">${safeId}</div>
              <div class="row">${escapeHtml(e.path || '')}</div>
              <div class="row">${escapeHtml((e.width || 0) + 'x' + (e.height || 0))} | ${(e.frames || 0)}f | ${(e.sizeKb || 0)}kb</div>
              <div class="row">reasons: ${escapeHtml(reasons)}</div>
              <div class="decision">decision: ${decision ? `<span class="${decision === 'approve' ? 'approve' : 'reject'}">${escapeHtml(decision)}</span>` : 'none'}</div>
              <span class="pill s-${escapeHtml(status)}">${escapeHtml(status)}</span>
              ${(e.themes || []).map(t => `<span class="pill">${escapeHtml(t)}</span>`).join('')}
              <div class="actions">
                <button class="a-approve" data-id="${encodedId}" data-action="approve">approve</button>
                <button class="a-reject" data-id="${encodedId}" data-action="reject">reject</button>
                <button class="a-clear" data-id="${encodedId}" data-action="clear">clear</button>
              </div>
            </article>
          `;
        }).join('');
      }

      for (const k of ['status', 'theme', 'folder', 'sort']) {
        els[k].addEventListener('change', render);
      }
      els.q.addEventListener('input', render);
      els.reload.addEventListener('click', () => loadManifest().catch(showError));
      els.presetFull.addEventListener('click', () => {
        els.status.value = 'all';
        els.folder.value = 'all';
        render();
      });
      els.presetReview.addEventListener('click', () => {
        els.status.value = 'needs_review';
        els.folder.value = 'inbox';
        render();
      });
      els.grid.addEventListener('click', async (event) => {
        const btn = event.target.closest('button[data-id][data-action]');
        if (!btn) return;
        const id = decodeURIComponent(btn.getAttribute('data-id') || '');
        const action = btn.getAttribute('data-action');
        if (!id || !action) return;
        try {
          await saveDecision(id, action);
          render();
        } catch (error) {
          showError(error);
        }
      });

      function showError(error) {
        els.meta.innerHTML = `<span style="color:#ff6b6b">${escapeHtml(error.message || String(error))}</span>`;
      }

      loadManifest().catch(showError);
    </script>
  </body>
</html>
